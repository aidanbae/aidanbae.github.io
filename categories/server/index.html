<!doctype html>
<html class="no-js" lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="author" content="Aidan.bae">
        <meta name="description" content="아이단의 블로그">
        <meta name="keywords" content="golang,aidan,kakaogames,kakao,gocd,gocd-agent,infra,javascript,python">
        <meta name="generator" content="Hugo 0.60.0" />
        <title> Server | 아이단은 어디갔을까</title>
        <meta name="description" content="Server - 아이단의 블로그">
        <meta itemprop="name" content="Server">
        <meta itemprop="description" content="Server - 아이단의 블로그">
        <meta property="og:title" content="Server">
        <meta property="og:description" content="Server - 아이단의 블로그">
        <meta property="og:image" content="https://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?size=200">
        <meta property="og:url" content="https://aidanbae.github.io/categories/server/">
        <meta property="og:site_name" content="아이단은 어디갔을까"><meta property="og:type" content="website">
        <link rel="icon" type="image/png" href="https://aidanbae.github.io/favicon-32x32.png" sizes="32x32">
        <link rel="icon" type="image/png" href="https://aidanbae.github.io/favicon-16x16.png" sizes="16x16">

	
	  <link href="https://aidanbae.github.io/categories/server/" rel="alternate" type="application/rss+xml" title="아이단은 어디갔을까" />
	  <link href="https://aidanbae.github.io/categories/server/" rel="feed" type="application/rss+xml" title="아이단은 어디갔을까" />
	

        
        
        
        
        <link rel="stylesheet" href="https://aidanbae.github.io/sass/combined.min.e5af985042854cb05807bed3365180e76bf9b8e0f41a2c81f098583599a6fb05.css">

        

        
            
        
    </head>
    <body class="bilberry-hugo-theme">
        
<nav>

    <div class="container">
        <ul class="topnav">
            
                
                    <li><a href="https://aidanbae.github.io/page/about-aidan/">Aidan</a></li>
                
            
        </ul>

        
    </div>
</nav>


        <header>
    <div class="container">
        <div class="logo">
            <a href="https://aidanbae.github.io/" class="logo">
                
                    <img src="https://aidanbae.github.io/do.png" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title"><a href="https://aidanbae.github.io/">아이단은 어디갔을까</a></h3>
            
                <span class="subtitle">순간 순간이 소중한 목적지</span>
            
        </div>

    

        
        <div class="toggler">
        
            <i class="fa fa-bars" aria-hidden="true"></i>
        </div>
    </div>
</header>


        <div class="main container">
            
    
    
        <div class="article-wrapper u-cf">
            
                <a class="bubble" href="https://aidanbae.github.io/code/devops/k8s/pleg/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://aidanbae.github.io/code/devops/k8s/pleg/">PLEG(Pod LifeCycle Event Generator)와 kubelet</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2020-08-01</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
                    <a href="https://aidanbae.github.io/categories/devops">DevOps</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        <h3 id="kubelet-architecture">kubelet architecture</h3>
<p><img src="kubelet_arch.png" alt="china_kubeletarch.png">
출처:
<a href="https://programmer.help/blogs/kubelet-source-code-analysis-startup.html">https://programmer.help/blogs/kubelet-source-code-analysis-startup.html</a></p>
<p>그림처럼 kubelet에는 다양한 컴포넌트들이 하위 고루틴으로 돌아가고있다.</p>
<hr>
<p>centos 기준 어떤 특정머신에 이슈가 있을때 가장 자주 쳐보는 명령어</p>
<pre><code>journalctl -xf
</code></pre><p>unit 옵션을 주어서 kubelet 로그만 확인한다.</p>
<pre><code>journalctl -xfu kubelet
</code></pre><p>k8s 머신장애 상황 or not ready 인 상태에서 kubelet 로그들이 가장 활발한 활동을 보여준다.<br>
당연한 이야기이지만 SRE나 인프라 책임이라면 장애시 필요한 로그를 빠르게 확인할 수 있어야한다.
오늘 포스팅에서는 쿠버네티스 클러스터에서 항상 중요 로그를 쏟아내는 kubelet과   그
로그에 종종볼수 있는 PLEG라는 것의 실체를 가볍게 확인해본다.</p>
<h5 id="k8s-kubeletgo-sourcecode-115-">k8s kubelet.go SourceCode (1.15버전 기준)</h5>
<p><a href="https://github.com/kubernetes/kubernetes/blob/7e75a5ef43b3e1db761e8152ac654cfa67dd62bd/pkg/kubelet/kubelet.go"><a href="https://github.com/kubernetes/kubernetes/blob/7e75a5ef43b3e1db761e8152ac654cfa67dd62bd/pkg/kubelet/kubelet.go">https://github.com/kubernetes/kubernetes/blob/7e75a5ef43b3e1db761e8152ac654cfa67dd62bd/pkg/kubelet/kubelet.go</a></a></p>
<p>const는 상수이기때문에 쿠버네티스에서 바꾸지못하도록 세팅해둔 값</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#66d9ef">const</span> (
	<span style="color:#75715e">// Max amount of time to wait for the container runtime to come up.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">maxWaitForContainerRuntime</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>

	<span style="color:#75715e">// nodeStatusUpdateRetry specifies how many times kubelet retries when posting node status failed.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nodeStatusUpdateRetry</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>

	<span style="color:#75715e">// ContainerLogsDir is the location of container logs.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ContainerLogsDir</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/var/log/containers&#34;</span>

	<span style="color:#75715e">// MaxContainerBackOff is the max backoff period, exported for the e2e test
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">MaxContainerBackOff</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>

	<span style="color:#75715e">// Period for performing global cleanup tasks.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">housekeepingPeriod</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>

	<span style="color:#75715e">// Period for performing eviction monitoring.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO ensure this is in sync with internal cadvisor housekeeping.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">evictionMonitoringPeriod</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">10</span>

	<span style="color:#75715e">// The path in containers&#39; filesystems where the hosts file is mounted.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">etcHostsPath</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;/etc/hosts&#34;</span>

	<span style="color:#75715e">// Capacity of the **channel** for receiving pod lifecycle events. This number
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// is a bit arbitrary and may be adjusted in the future.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">plegChannelCapacity</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>
<span style="color:#75715e">// Generic PLEG relies on relisting for discovering container events.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// A longer period means that kubelet will take longer to detect container
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// changes and to update pod status. On the other hand, a shorter period
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// will cause more frequent relisting (e.g., container runtime operations),
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// leading to higher cpu usage.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Note that even though we set the period to 1s, **the relisting itself can
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// take more than 1s to finish if the container runtime responds slowly
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// and/or when there are many container changes in one cycle.**
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">plegRelistPeriod</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>

...

</code></pre></div><p>아래쪽에 <code>pleg</code>라는 단어가 눈에 띈다.
이는 pod lifecycle event generator의 약자인데
Pleg (Pod LifeCycle Event Generator)와 관련된 로그는 이슈 발생시 쉽게 확인할 수 있다.</p>
<p>pleg Channel Capa는 1000.
golang channel은 goroutine간의 통신을 위해 비동기, 동적으로 동작하는 큐인데 위의 버퍼사이즈 1000개가 꽉차는 순간 blocking 발생.
이후부터 동기적으로 동작하는 특성을 가지고있다.</p>
<p>plegRelistPeriod 무언가 주기가 있나보다 뒤에서 확인해보자.</p>
<p>의도적으로 oom을 내었던 mem-test라는 파드에 대한 kubelet로그:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">18.316391</span> <span style="color:#ae81ff">2449754</span> <span style="color:#a6e22e">kubelet</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1933</span>] <span style="color:#a6e22e">SyncLoop</span> (<span style="color:#a6e22e">PLEG</span>)<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>, <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">PodLifecycleEvent</span>{<span style="color:#a6e22e">ID</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;503eff33-754a-4938-8a71-c6ac261ebb6c&#34;</span>, <span style="color:#a6e22e">Type</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ContainerDied&#34;</span>, <span style="color:#a6e22e">Data</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;a00d5fef27e49d975847a6cec03a2144d46dcc72dd3cfbf86f35b7cf997a9434&#34;</span>}
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">E0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">18.317234</span> <span style="color:#ae81ff">2449754</span> <span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">pod_workers</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">:</span><span style="color:#ae81ff">190</span>] Error <span style="color:#a6e22e">syncing</span> <span style="color:#a6e22e">pod</span> <span style="color:#ae81ff">503</span><span style="color:#a6e22e">eff33</span><span style="color:#f92672">-</span><span style="color:#ae81ff">754</span><span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4938</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">a71</span><span style="color:#f92672">-</span><span style="color:#a6e22e">c6ac261ebb6c</span> (<span style="color:#e6db74">&#34;mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>), <span style="color:#a6e22e">skipping</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">to</span> <span style="color:#e6db74">&#34;StartContainer&#34;</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;mem-test&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">CrashLoopBackOff</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Back-off 1m20s restarting failed container=mem-test pod=mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">26.852529</span> <span style="color:#ae81ff">2449754</span> <span style="color:#a6e22e">setters</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">73</span>] <span style="color:#a6e22e">Using</span> <span style="color:#a6e22e">node</span> <span style="color:#a6e22e">IP</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;172.--.--.--&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">E0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">33.619148</span> <span style="color:#ae81ff">2449754</span> <span style="color:#a6e22e">pod_workers</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">190</span>] Error <span style="color:#a6e22e">syncing</span> <span style="color:#a6e22e">pod</span> <span style="color:#ae81ff">503</span><span style="color:#a6e22e">eff33</span><span style="color:#f92672">-</span><span style="color:#ae81ff">754</span><span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4938</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">a71</span><span style="color:#f92672">-</span><span style="color:#a6e22e">c6ac261ebb6c</span> (<span style="color:#e6db74">&#34;mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>), <span style="color:#a6e22e">skipping</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">to</span> <span style="color:#e6db74">&#34;StartContainer&#34;</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;mem-test&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">CrashLoopBackOff</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Back-off 1m20s restarting failed container=mem-test pod=mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">36.866426</span> <span style="color:#ae81ff">2449754</span> <span style="color:#a6e22e">setters</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">73</span>] <span style="color:#a6e22e">Using</span> <span style="color:#a6e22e">node</span> <span style="color:#a6e22e">IP</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;172.------&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">42.384150</span> <span style="color:#ae81ff">2449754</span> <span style="color:#a6e22e">container_manager_linux</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">457</span>] [<span style="color:#a6e22e">ContainerManager</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">Discovered</span> <span style="color:#a6e22e">runtime</span> <span style="color:#a6e22e">cgroups</span> <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">d</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">l</span><span style="color:#960050;background-color:#1e0010">i</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">e</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">2449754</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">E0616</span> <span style="color:#ae81ff">16</span><span style="color:#f92672">:</span><span style="color:#ae81ff">54</span><span style="color:#f92672">:</span><span style="color:#ae81ff">45.619505</span> <span style="color:#ae81ff">2449754</span> <span style="color:#a6e22e">pod_workers</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">190</span>] Error <span style="color:#a6e22e">syncing</span> <span style="color:#a6e22e">pod</span> <span style="color:#ae81ff">503</span><span style="color:#a6e22e">eff33</span><span style="color:#f92672">-</span><span style="color:#ae81ff">754</span><span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4938</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">a71</span><span style="color:#f92672">-</span><span style="color:#a6e22e">c6ac261ebb6c</span> (<span style="color:#e6db74">&#34;mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>), <span style="color:#a6e22e">skipping</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">failed</span> <span style="color:#a6e22e">to</span> <span style="color:#e6db74">&#34;StartContainer&#34;</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;mem-test&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">CrashLoopBackOff</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Back-off 1m20s restarting failed container=mem-test pod=mem-test-68bcccd59d-974pr_live(503eff33-754a-4938-8a71-c6ac261ebb6c)&#34;</span>
</code></pre></div><p>SyncLoop라는 것과 함께 PLEG를 확인할 수 있다.</p>
<h4 id="--kubelet-pleg-">그렇다면 본격적으로 kubelet과 pleg를 알아보자.</h4>
<p><img src="pleg.png" alt="pleg.png"></p>
<p>kubelet은 파드스펙의 변경을 마스터로부터 전달 받을 수도 있고 머신으로부터 파드와 관련된 이벤트(ex. oom)를 전달받아 액션이 수행될 수 있다.
그렇기 때문에 이런 다양한 상황을 통제하는 SyncLoop가 존재하고 각각의 이벤트 source에 따라 다른 처리를 하고있다.</p>
<p><img src="kubelet_syncloop.png" alt="kubelet_syncloop.png"></p>
<p>kubelet은 이렇듯 multiple sources로 부터 일어나는 파드 스펙 변화를 감지해야하고, 또 한편으로 컨테이너 런타임을 주기적으로 polling해서 모든 컨테이너의 최신 상태를 점검해야한다.</p>
<!-- raw HTML omitted -->
<h5 id="relist-----">relist를 이용한 컨테이너 상태 변화 감시</h5>
<p>pod lifecycle event를 생성하기 위해 PLEG는 모든 컨테이너의 상태 변화를 감지할수 있어야한다. PLEG는 주기적인 relist 작업을 통해 이것을 수행해낸다. (docker ps라고 생각하면 편하다.) 단일 스레드(PLEG)에 의해서만 수행되며. 모든 파드 작업자가 동시에 컨테이너 런타임에 도달하지 않아도 된다는 이점이 있음.
relisting의 장점은 컨테이너 런타임에 구애받지 않고 외부 종속성이 필요없다는 것이다.</p>
<p>ple 구조체:</p>
<p><img src="pleg_package.png" alt="pleg_package.png"></p>
<p>갑자기 golang</p>
<p>golang은 <code>effective- go</code> 라는 책에서부터 인스턴스에 대한 Initializing 패턴이 조금 정형화된 느낌이 있다.</p>
<p><code>New~</code>라는 prefix를 가진 함수를 보면 특정 주요 객체에 대해 initializing을 함.</p>
<p>istio의 믹서 서버 이니셜라이징:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#75715e">// istio /mixer /server.go
</span><span style="color:#75715e"></span><span style="color:#a6e22e">func</span> <span style="color:#a6e22e">newServer</span>(<span style="color:#a6e22e">a</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Args</span>, <span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">patchTable</span>) (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>, <span style="color:#a6e22e">err</span> <span style="color:#a6e22e">error</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">validate</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">configLog</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">LoggingOptions</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Server</span>{}

	<span style="color:#a6e22e">defer</span> <span style="color:#a6e22e">func</span>() {
		<span style="color:#75715e">// If return with error, need to close the server.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
			<span style="color:#a6e22e">_</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Close</span>()
		}
	}()

	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">gp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">NewGoroutinePool</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">APIWorkerPoolSize</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">SingleThreaded</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">gp</span>.<span style="color:#a6e22e">AddWorkers</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">APIWorkerPoolSize</span>)

	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">adapterGP</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">NewGoroutinePool</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">AdapterWorkerPoolSize</span>, <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">SingleThreaded</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">adapterGP</span>.<span style="color:#a6e22e">AddWorkers</span>(<span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">AdapterWorkerPoolSize</span>)
</code></pre></div><p>보통 이 New로 시작하는 함수에서 다양한 파생 goroutine을 실행하고 들고 있기때문에. 이부분을 확인하면되고</p>
<p>init() , start() , run() 같은 리시버 함수까지 확인하면 보통 주요한 설정들을 다 확인할 수있음.</p>
<p>다음은 큐블렛의 이니셜라이징:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#75715e">// NewMainKubelet instantiates a new Kubelet object along with all the required internal modules.
</span><span style="color:#75715e"></span><span style="color:#75715e">// No initialization of Kubelet and its modules should happen here.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">func</span> <span style="color:#a6e22e">NewMainKubelet</span>(<span style="color:#a6e22e">kubeCfg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">kubeletconfiginternal</span>.<span style="color:#a6e22e">KubeletConfiguration</span>,
	<span style="color:#a6e22e">kubeDeps</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Dependencies</span>,
	<span style="color:#a6e22e">crOptions</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">ContainerRuntimeOptions</span>,
	<span style="color:#a6e22e">containerRuntime</span> <span style="color:#a6e22e">string</span>,
	<span style="color:#a6e22e">hostname</span> <span style="color:#a6e22e">string</span>,
	<span style="color:#a6e22e">hostnameOverridden</span> <span style="color:#a6e22e">bool</span>,
	<span style="color:#a6e22e">nodeName</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">NodeName</span>,
	<span style="color:#a6e22e">nodeIP</span> <span style="color:#a6e22e">string</span>,
	<span style="color:#a6e22e">providerID</span> <span style="color:#a6e22e">string</span>,
...

<span style="color:#a6e22e">containerGCPolicy</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">kubecontainer</span>.<span style="color:#a6e22e">GCPolicy</span>{
		<span style="color:#a6e22e">MinAge</span><span style="color:#f92672">:</span>             <span style="color:#a6e22e">minimumGCAge</span>.<span style="color:#a6e22e">Duration</span>,
		<span style="color:#a6e22e">MaxPerPodContainer</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">maxPerPodContainerCount</span>),
		<span style="color:#a6e22e">MaxContainers</span><span style="color:#f92672">:</span>      <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">maxContainerCount</span>),
	}

	<span style="color:#a6e22e">daemonEndpoints</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">NodeDaemonEndpoints</span>{
		<span style="color:#a6e22e">KubeletEndpoint</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">DaemonEndpoint</span>{<span style="color:#a6e22e">Port</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">Port</span>},
	}

	<span style="color:#a6e22e">imageGCPolicy</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">images</span>.<span style="color:#a6e22e">ImageGCPolicy</span>{
		<span style="color:#a6e22e">MinAge</span><span style="color:#f92672">:</span>               <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ImageMinimumGCAge</span>.<span style="color:#a6e22e">Duration</span>,
		<span style="color:#a6e22e">HighThresholdPercent</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ImageGCHighThresholdPercent</span>),
		<span style="color:#a6e22e">LowThresholdPercent</span><span style="color:#f92672">:</span>  <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ImageGCLowThresholdPercent</span>),
	}
...

<span style="color:#a6e22e">nodeLister</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">corelisters</span>.<span style="color:#a6e22e">NewNodeLister</span>(<span style="color:#a6e22e">nodeIndexer</span>)

	<span style="color:#75715e">// TODO: get the real node object of ourself,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// and use the real node name and UID.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// TODO: what is namespace for node?
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">nodeRef</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">ObjectReference</span>{
		<span style="color:#a6e22e">Kind</span><span style="color:#f92672">:</span>      <span style="color:#e6db74">&#34;Node&#34;</span>,
		<span style="color:#a6e22e">Name</span><span style="color:#f92672">:</span>      <span style="color:#a6e22e">string</span>(<span style="color:#a6e22e">nodeName</span>),
		<span style="color:#a6e22e">UID</span><span style="color:#f92672">:</span>       <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">UID</span>(<span style="color:#a6e22e">nodeName</span>),
		<span style="color:#a6e22e">Namespace</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
	}

	<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">oomWatcher</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">oomwatcher</span>.<span style="color:#a6e22e">NewWatcher</span>(<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#a6e22e">clusterDNS</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">make</span>([]<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">IP</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ClusterDNS</span>))
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ipEntry</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">range</span> <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ClusterDNS</span> {
		<span style="color:#a6e22e">ip</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ParseIP</span>(<span style="color:#a6e22e">ipEntry</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ip</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">nil</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;Invalid clusterDNS ip &#39;%q&#39;&#34;</span>, <span style="color:#a6e22e">ipEntry</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">clusterDNS</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">clusterDNS</span>, <span style="color:#a6e22e">ip</span>)
		}
	}
	<span style="color:#a6e22e">httpClient</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Client</span>{}
	<span style="color:#a6e22e">parsedNodeIP</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ParseIP</span>(<span style="color:#a6e22e">nodeIP</span>)
	<span style="color:#a6e22e">protocol</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">utilipt</span>.<span style="color:#a6e22e">ProtocolIPv4</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">utilnet</span>.<span style="color:#a6e22e">IsIPv6</span>(<span style="color:#a6e22e">parsedNodeIP</span>) {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">0</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;IPv6 node IP (%s), assume IPv6 operation&#34;</span>, <span style="color:#a6e22e">nodeIP</span>)
		<span style="color:#a6e22e">protocol</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">utilipt</span>.<span style="color:#a6e22e">ProtocolIPv6</span>
	}
...

<span style="color:#a6e22e">klet</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Kubelet</span>{
		<span style="color:#a6e22e">hostname</span><span style="color:#f92672">:</span>                                <span style="color:#a6e22e">hostname</span>,
		<span style="color:#a6e22e">hostnameOverridden</span><span style="color:#f92672">:</span>                      <span style="color:#a6e22e">hostnameOverridden</span>,
		<span style="color:#a6e22e">nodeName</span><span style="color:#f92672">:</span>                                <span style="color:#a6e22e">nodeName</span>,
		<span style="color:#a6e22e">kubeClient</span><span style="color:#f92672">:</span>                              <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">KubeClient</span>,
		<span style="color:#a6e22e">heartbeatClient</span><span style="color:#f92672">:</span>                         <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">HeartbeatClient</span>,
		<span style="color:#a6e22e">onRepeatedHeartbeatFailure</span><span style="color:#f92672">:</span>              <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">OnHeartbeatFailure</span>,
		<span style="color:#a6e22e">rootDirectory</span><span style="color:#f92672">:</span>                           <span style="color:#a6e22e">rootDirectory</span>,
		<span style="color:#a6e22e">resyncInterval</span><span style="color:#f92672">:</span>                          <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">SyncFrequency</span>.<span style="color:#a6e22e">Duration</span>,
		<span style="color:#a6e22e">sourcesReady</span><span style="color:#f92672">:</span>                            <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">NewSourcesReady</span>(<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">PodConfig</span>.<span style="color:#a6e22e">SeenAllSources</span>),
		<span style="color:#a6e22e">registerNode</span><span style="color:#f92672">:</span>                            <span style="color:#a6e22e">registerNode</span>,
		<span style="color:#a6e22e">registerWithTaints</span><span style="color:#f92672">:</span>                      <span style="color:#a6e22e">registerWithTaints</span>,
		<span style="color:#a6e22e">registerSchedulable</span><span style="color:#f92672">:</span>                     <span style="color:#a6e22e">registerSchedulable</span>,
		<span style="color:#a6e22e">dnsConfigurer</span><span style="color:#f92672">:</span>                           <span style="color:#a6e22e">dns</span>.<span style="color:#a6e22e">NewConfigurer</span>(<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>, <span style="color:#a6e22e">nodeRef</span>, <span style="color:#a6e22e">parsedNodeIP</span>, <span style="color:#a6e22e">clusterDNS</span>, <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ClusterDomain</span>, <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ResolverConfig</span>),
		<span style="color:#a6e22e">serviceLister</span><span style="color:#f92672">:</span>                           <span style="color:#a6e22e">serviceLister</span>,
		<span style="color:#a6e22e">serviceHasSynced</span><span style="color:#f92672">:</span>                        <span style="color:#a6e22e">serviceHasSynced</span>,
		<span style="color:#a6e22e">nodeLister</span><span style="color:#f92672">:</span>                              <span style="color:#a6e22e">nodeLister</span>,
		<span style="color:#a6e22e">masterServiceNamespace</span><span style="color:#f92672">:</span>                  <span style="color:#a6e22e">masterServiceNamespace</span>,
		<span style="color:#a6e22e">streamingConnectionIdleTimeout</span><span style="color:#f92672">:</span>          <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">StreamingConnectionIdleTimeout</span>.<span style="color:#a6e22e">Duration</span>,
		<span style="color:#a6e22e">recorder</span><span style="color:#f92672">:</span>                                <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>,
		<span style="color:#a6e22e">cadvisor</span><span style="color:#f92672">:</span>                                <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">CAdvisorInterface</span>,
		<span style="color:#a6e22e">cloud</span><span style="color:#f92672">:</span>                                   <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Cloud</span>,
		<span style="color:#a6e22e">externalCloudProvider</span><span style="color:#f92672">:</span>                   <span style="color:#a6e22e">cloudprovider</span>.<span style="color:#a6e22e">IsExternal</span>(<span style="color:#a6e22e">cloudProvider</span>),
		<span style="color:#a6e22e">providerID</span><span style="color:#f92672">:</span>                              <span style="color:#a6e22e">providerID</span>,
		<span style="color:#a6e22e">nodeRef</span><span style="color:#f92672">:</span>                                 <span style="color:#a6e22e">nodeRef</span>,
		<span style="color:#a6e22e">nodeLabels</span><span style="color:#f92672">:</span>                              <span style="color:#a6e22e">nodeLabels</span>,
		<span style="color:#a6e22e">nodeStatusUpdateFrequency</span><span style="color:#f92672">:</span>               <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">NodeStatusUpdateFrequency</span>.<span style="color:#a6e22e">Duration</span>,
		<span style="color:#a6e22e">nodeStatusReportFrequency</span><span style="color:#f92672">:</span>               <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">NodeStatusReportFrequency</span>.<span style="color:#a6e22e">Duration</span>,
		<span style="color:#a6e22e">os</span><span style="color:#f92672">:</span>                                      <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">OSInterface</span>,
		<span style="color:#a6e22e">oomWatcher</span><span style="color:#f92672">:</span>                              <span style="color:#a6e22e">oomWatcher</span>,
		<span style="color:#a6e22e">cgroupsPerQOS</span><span style="color:#f92672">:</span>                           <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">CgroupsPerQOS</span>,
		<span style="color:#a6e22e">cgroupRoot</span><span style="color:#f92672">:</span>                              <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">CgroupRoot</span>,
		<span style="color:#a6e22e">mounter</span><span style="color:#f92672">:</span>                                 <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Mounter</span>,
		<span style="color:#a6e22e">hostutil</span><span style="color:#f92672">:</span>                                <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">HostUtil</span>,
		<span style="color:#a6e22e">subpather</span><span style="color:#f92672">:</span>                               <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Subpather</span>,
		<span style="color:#a6e22e">maxPods</span><span style="color:#f92672">:</span>                                 <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">MaxPods</span>),
		<span style="color:#a6e22e">podsPerCore</span><span style="color:#f92672">:</span>                             <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">PodsPerCore</span>),
		<span style="color:#a6e22e">syncLoopMonitor</span><span style="color:#f92672">:</span>                         <span style="color:#a6e22e">atomic</span>.<span style="color:#a6e22e">Value</span>{},
		<span style="color:#a6e22e">daemonEndpoints</span><span style="color:#f92672">:</span>                         <span style="color:#a6e22e">daemonEndpoints</span>,
		<span style="color:#a6e22e">containerManager</span><span style="color:#f92672">:</span>                        <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">ContainerManager</span>,
		<span style="color:#a6e22e">containerRuntimeName</span><span style="color:#f92672">:</span>                    <span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">containerRuntime</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>,
		<span style="color:#a6e22e">redirectContainerStreaming</span><span style="color:#f92672">:</span>              <span style="color:#a6e22e">crOptions</span>.<span style="color:#a6e22e">RedirectContainerStreaming</span>,
		<span style="color:#a6e22e">nodeIP</span><span style="color:#f92672">:</span>                                  <span style="color:#a6e22e">parsedNodeIP</span>,
		<span style="color:#a6e22e">nodeIPValidator</span><span style="color:#f92672">:</span>                         <span style="color:#a6e22e">validateNodeIP</span>,
		<span style="color:#a6e22e">clock</span><span style="color:#f92672">:</span>                                   <span style="color:#a6e22e">clock</span>.<span style="color:#a6e22e">RealClock</span>{},
		<span style="color:#a6e22e">enableControllerAttachDetach</span><span style="color:#f92672">:</span>            <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">EnableControllerAttachDetach</span>,
		<span style="color:#a6e22e">iptClient</span><span style="color:#f92672">:</span>                               <span style="color:#a6e22e">utilipt</span>.<span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">utilexec</span>.<span style="color:#a6e22e">New</span>(), <span style="color:#a6e22e">protocol</span>),
		<span style="color:#a6e22e">makeIPTablesUtilChains</span><span style="color:#f92672">:</span>                  <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">MakeIPTablesUtilChains</span>,
		<span style="color:#a6e22e">iptablesMasqueradeBit</span><span style="color:#f92672">:</span>                   <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">IPTablesMasqueradeBit</span>),
		<span style="color:#a6e22e">iptablesDropBit</span><span style="color:#f92672">:</span>                         <span style="color:#66d9ef">int</span>(<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">IPTablesDropBit</span>),
		<span style="color:#a6e22e">experimentalHostUserNamespaceDefaulting</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">utilfeature</span>.<span style="color:#a6e22e">DefaultFeatureGate</span>.<span style="color:#a6e22e">Enabled</span>(<span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">ExperimentalHostUserNamespaceDefaultingGate</span>),
		<span style="color:#a6e22e">keepTerminatedPodVolumes</span><span style="color:#f92672">:</span>                <span style="color:#a6e22e">keepTerminatedPodVolumes</span>,
		<span style="color:#a6e22e">nodeStatusMaxImages</span><span style="color:#f92672">:</span>                     <span style="color:#a6e22e">nodeStatusMaxImages</span>,
		<span style="color:#a6e22e">lastContainerStartedTime</span><span style="color:#f92672">:</span>                <span style="color:#a6e22e">newTimeCache</span>(),
	}
...
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">ServerTLSBootstrap</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">TLSOptions</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">utilfeature</span>.<span style="color:#a6e22e">DefaultFeatureGate</span>.<span style="color:#a6e22e">Enabled</span>(<span style="color:#a6e22e">features</span>.<span style="color:#a6e22e">RotateKubeletServerCertificate</span>) {
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">serverCertificateManager</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">kubeletcertificate</span>.<span style="color:#a6e22e">NewKubeletServerCertificateManager</span>(<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">kubeClient</span>, <span style="color:#a6e22e">kubeCfg</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">nodeName</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">getLastObservedNodeAddresses</span>, <span style="color:#a6e22e">certDirectory</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;failed to initialize certificate manager: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
		}
		<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">TLSOptions</span>.<span style="color:#a6e22e">Config</span>.<span style="color:#a6e22e">GetCertificate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">func</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">ClientHelloInfo</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">tls</span>.<span style="color:#a6e22e">Certificate</span>, <span style="color:#a6e22e">error</span>) {
			<span style="color:#a6e22e">cert</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">serverCertificateManager</span>.<span style="color:#a6e22e">Current</span>()
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">cert</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">nil</span> {
				<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;no serving certificate available for the kubelet&#34;</span>)
			}
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cert</span>, <span style="color:#a6e22e">nil</span>
		}
	}
</code></pre></div><p>1년 지나서 인증서 이슈때 보게되는 로그</p>
<p>좀더 아래엔 친숙한 애들이 다 선언되어있음.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">probeManager</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">prober</span>.<span style="color:#a6e22e">NewManager</span>(
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">statusManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">livenessManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">startupManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">runner</span>,
		<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>)

	<span style="color:#a6e22e">tokenManager</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">NewManager</span>(<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">KubeClient</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx">
<span style="color:#75715e">// setup volumeManager
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">volumeManager</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">volumemanager</span>.<span style="color:#a6e22e">NewVolumeManager</span>(
		<span style="color:#a6e22e">kubeCfg</span>.<span style="color:#a6e22e">EnableControllerAttachDetach</span>,
		<span style="color:#a6e22e">nodeName</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">statusManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">kubeClient</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">volumePluginMgr</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">containerRuntime</span>,
		<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Mounter</span>,
		<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">HostUtil</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">getPodsDir</span>(),
		<span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>,
		<span style="color:#a6e22e">experimentalCheckNodeCapabilitiesBeforeMount</span>,
		<span style="color:#a6e22e">keepTerminatedPodVolumes</span>,
		<span style="color:#a6e22e">volumepathhandler</span>.<span style="color:#a6e22e">NewBlockVolumePathHandler</span>())

	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">reasonCache</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NewReasonCache</span>()
	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">workQueue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">queue</span>.<span style="color:#a6e22e">NewBasicWorkQueue</span>(<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">clock</span>)
	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podWorkers</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">newPodWorkers</span>(<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">syncPod</span>, <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">workQueue</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">resyncInterval</span>, <span style="color:#a6e22e">backOffPeriod</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podCache</span>)

	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">backOff</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">flowcontrol</span>.<span style="color:#a6e22e">NewBackOff</span>(<span style="color:#a6e22e">backOffPeriod</span>, <span style="color:#a6e22e">MaxContainerBackOff</span>)
	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podKiller</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NewPodKiller</span>(<span style="color:#a6e22e">klet</span>)

	<span style="color:#a6e22e">etcHostsPathFunc</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">podUID</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">UID</span>) <span style="color:#a6e22e">string</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">getEtcHostsPath</span>(<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">getPodDir</span>(<span style="color:#a6e22e">podUID</span>)) }
	<span style="color:#75715e">// setup eviction manager
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">evictionManager</span>, <span style="color:#a6e22e">evictionAdmitHandler</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">eviction</span>.<span style="color:#a6e22e">NewManager</span>(<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">resourceAnalyzer</span>, <span style="color:#a6e22e">evictionConfig</span>, <span style="color:#a6e22e">killPodNow</span>(<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podWorkers</span>, <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>), <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">podManager</span>.<span style="color:#a6e22e">GetMirrorPodByPod</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">imageManager</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">containerGC</span>, <span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span>, <span style="color:#a6e22e">nodeRef</span>, <span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">clock</span>, <span style="color:#a6e22e">etcHostsPathFunc</span>)

	<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">evictionManager</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">evictionManager</span>

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#75715e">// Run starts the kubelet reacting to config updates
</span><span style="color:#75715e"></span><span style="color:#a6e22e">func</span> (<span style="color:#a6e22e">kl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Kubelet</span>) <span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">updates</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chan</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">PodUpdate</span>) {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">logServer</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">logServer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StripPrefix</span>(<span style="color:#e6db74">&#34;/logs/&#34;</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">FileServer</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Dir</span>(<span style="color:#e6db74">&#34;/var/log/&#34;</span>)))
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Warning</span>(<span style="color:#e6db74">&#34;No api server defined - no node status update will be sent.&#34;</span>)
	}

	<span style="color:#75715e">// Start the cloud provider sync manager
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">cloudResourceSyncManager</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">cloudResourceSyncManager</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
	}

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">initializeModules</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">recorder</span>.<span style="color:#a6e22e">Eventf</span>(<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">nodeRef</span>, <span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">EventTypeWarning</span>, <span style="color:#a6e22e">events</span>.<span style="color:#a6e22e">KubeletSetupFailed</span>, <span style="color:#a6e22e">err</span>.Error())
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#75715e">// Start volume manager
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">volumeManager</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">sourcesReady</span>, <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">kubeClient</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#75715e">// Start syncing node status immediately, this may set up things the runtime needs to run.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">syncNodeStatus</span>, <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">nodeStatusUpdateFrequency</span>, <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
		<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">fastStatusUpdateOnce</span>()

		<span style="color:#75715e">// start syncing lease
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">nodeLeaseController</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
	}
	<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">updateRuntimeUp</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)

	<span style="color:#75715e">// Set up iptables util rules
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">makeIPTablesUtilChains</span> {
		<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">initNetworkUtil</span>()
	}

	<span style="color:#75715e">// Start a goroutine responsible for killing pods (that are not properly
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// handled by pod workers).
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">go</span> <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">Until</span>(<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">podKiller</span>.<span style="color:#a6e22e">PerformPodKillingWork</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">*</span><span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>, <span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)

	<span style="color:#75715e">// Start component sync loops.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">kl</span>.<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">statusManager</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#a6e22e">kl</span>.<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">probeManager</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>.<span style="color:#a6e22e">Start</span>()

	<span style="color:#75715e">// Start syncing RuntimeClasses if enabled.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">runtimeClassManager</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
		<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">runtimeClassManager</span>.<span style="color:#a6e22e">Start</span>(<span style="color:#a6e22e">wait</span>.<span style="color:#a6e22e">NeverStop</span>)
	}

	<span style="color:#75715e">// Start the pod lifecycle event generator.
</span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">Start</span>()
	<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">syncLoop</span>(<span style="color:#a6e22e">updates</span>, <span style="color:#a6e22e">kl</span>)<span style="color:#f92672">*</span><span style="color:#f92672">*</span>
}
</code></pre></div><p>Sync는 Desire state를 선언하는 식(declaretive)으로 리소스를 관리하는 쿠버네티스에게 중요한 함수들임.</p>
<p>선언한 상태와 현재 상태를 지속적으로 비교하고 선언한상태에 맞춰줘야하기때문에 Sync~관련 함수들이 자주 호출됨.</p>
<p><img src="kubelet_syncloop.png" alt="kubelet_syncloop.png"></p>
<p>kubelet sync루프 함수의 핵심은. 저 노란 조건문 부분임. iteration 부분</p>
<p>channel을 자주 사용하는 golang의 경우
select문을 종종 볼수 있는데
여러개의 채널(큐)에 데이터가 들어오길 동시에 기다리는 역할을 함.
주로 select문이 선언된 함수는 go runtime이 특별하게 관리하며,
case형태로 분기감시하는 channel단에 이벤트가 들어오면 런타임이 해당 goroutine을 awake시키는 형태로 관리됨. <strong>순서가 보장됨</strong>.</p>
<p>복수개의 채널을 감시한다는것 자체가 꽤나 중요한 역할을 하는 함수라는 것을 뜻함.
그만큼 많은 테스트가 필요하고 프로젝트 주요 핵심 비즈니스 로직이 담겨져있을 가능성이 큼.</p>
<p>syncLoopIteration 함수는 select문을 활용해 다음과 같은 5개 채널을 계속 감시하고 이벤트가 들어오길 기다리고잇음.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#75715e">// Arguments:
</span><span style="color:#75715e"></span><span style="color:#75715e">// 1.  configCh:       a channel to read config events from
</span><span style="color:#75715e"></span><span style="color:#75715e">// 2.  handler:        the SyncHandler to dispatch pods to
</span><span style="color:#75715e"></span><span style="color:#75715e">// 3.  syncCh:         a channel to read periodic sync events from
</span><span style="color:#75715e"></span><span style="color:#75715e">// 4.  housekeepingCh: a channel to read housekeeping events from
</span><span style="color:#75715e"></span><span style="color:#75715e">// 5.  plegCh:         a channel to read PLEG updates from
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// * configCh: dispatch the pods for the config change to the appropriate
</span><span style="color:#75715e"></span><span style="color:#75715e">//             handler callback for the event type
</span><span style="color:#75715e"></span><span style="color:#75715e">// * plegCh: update the runtime cache; sync pod
</span><span style="color:#75715e"></span><span style="color:#75715e">// * syncCh: sync all pods waiting for sync
</span><span style="color:#75715e"></span><span style="color:#75715e">// * housekeepingCh: trigger cleanup of pods
</span><span style="color:#75715e"></span><span style="color:#75715e">// * liveness manager: sync pods that have failed or in which one or more
</span><span style="color:#75715e"></span><span style="color:#75715e">//                     containers have failed liveness checks
</span></code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">func</span> (<span style="color:#a6e22e">kl</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Kubelet</span>) <span style="color:#a6e22e">syncLoopIteration</span>(<span style="color:#a6e22e">configCh</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chan</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">PodUpdate</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">SyncHandler</span>,
	<span style="color:#a6e22e">syncCh</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chan</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">housekeepingCh</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chan</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Time</span>, <span style="color:#a6e22e">plegCh</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">PodLifecycleEvent</span>) <span style="color:#a6e22e">bool</span> {
	<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">select</span> {<span style="color:#f92672">*</span><span style="color:#f92672">*</span>
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">open</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">configCh</span><span style="color:#f92672">:</span>
		<span style="color:#75715e">// Update from a config source; dispatch it to the right handler
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// callback.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">open</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Update channel is closed. Exiting the sync loop.&#34;</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
		}

		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Op</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">ADD</span><span style="color:#f92672">:</span>
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (ADD, %q): %q&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
			<span style="color:#75715e">// After restarting, kubelet will get all existing pods through
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// ADD as if they are new pods. These pods will then go through the
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// admission process and *may* be rejected. This can be resolved
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// once we have checkpointing.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodAdditions</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">UPDATE</span><span style="color:#f92672">:</span>
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (UPDATE, %q): %q&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">PodsWithDeletionTimestamps</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodUpdates</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">REMOVE</span><span style="color:#f92672">:</span>
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (REMOVE, %q): %q&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodRemoves</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">RECONCILE</span><span style="color:#f92672">:</span>
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (RECONCILE, %q): %q&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodReconcile</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)
		<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">DELETE</span><span style="color:#f92672">:</span>
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (DELETE, %q): %q&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>))
			<span style="color:#75715e">// DELETE is treated as a UPDATE because of graceful deletion.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodUpdates</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Pods</span>)<span style="color:#f92672">*</span><span style="color:#f92672">*</span>
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">kubetypes</span>.<span style="color:#a6e22e">SET</span><span style="color:#f92672">:</span>
			<span style="color:#75715e">// TODO: Do we want to support this?
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Kubelet does not support snapshot update&#34;</span>)
		<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Invalid event type received: %d.&#34;</span>, <span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Op</span>)
		}

		<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">sourcesReady</span>.<span style="color:#a6e22e">AddSource</span>(<span style="color:#a6e22e">u</span>.<span style="color:#a6e22e">Source</span>)

	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">plegCh</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">:</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">ContainerStarted</span> {
			<span style="color:#75715e">// record the most recent time we observed a container start for this pod.
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// this lets us selectively invalidate the runtimeCache when processing a delete for this pod
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// to make sure we don&#39;t miss handling graceful termination for containers we reported as having started.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">lastContainerStartedTime</span>.<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>())
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">isSyncPodWorthy</span>(<span style="color:#a6e22e">e</span>) {
			<span style="color:#75715e">// PLEG event for a pod; sync it.
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">podManager</span>.<span style="color:#a6e22e">GetPodByUID</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>); <span style="color:#a6e22e">ok</span> {
				<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">2</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (PLEG): %q, event: %#v&#34;</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pod</span>(<span style="color:#a6e22e">pod</span>), <span style="color:#a6e22e">e</span>)<span style="color:#f92672">*</span><span style="color:#f92672">*</span>
				<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodSyncs</span>([]<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>{<span style="color:#a6e22e">pod</span>})
			} <span style="color:#66d9ef">else</span> {
				<span style="color:#75715e">// If the pod no longer exists, ignore the event.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (PLEG): ignore irrelevant event: %#v&#34;</span>, <span style="color:#a6e22e">e</span>)
			}
		}

		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">ContainerDied</span> {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">containerID</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Data</span>.(<span style="color:#a6e22e">string</span>); <span style="color:#a6e22e">ok</span> {
				<span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">cleanUpContainersInPod</span>(<span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">ID</span>, <span style="color:#a6e22e">containerID</span>)
			}
		}
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">syncCh</span><span style="color:#f92672">:</span>
		<span style="color:#75715e">// Sync pods waiting for sync
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">podsToSync</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">getPodsToSync</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">podsToSync</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (SYNC): %d pods; %s&#34;</span>, <span style="color:#a6e22e">len</span>(<span style="color:#a6e22e">podsToSync</span>), <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pods</span>(<span style="color:#a6e22e">podsToSync</span>))
		<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodSyncs</span>(<span style="color:#a6e22e">podsToSync</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">update</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">livenessManager</span>.<span style="color:#a6e22e">Updates</span>()<span style="color:#f92672">:</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">update</span>.<span style="color:#a6e22e">Result</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">proberesults</span>.<span style="color:#a6e22e">Failure</span> {
			<span style="color:#75715e">// The liveness manager detected a failure; sync the pod.
</span><span style="color:#75715e"></span>
			<span style="color:#75715e">// We should not use the pod from livenessManager, because it is never updated after
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// initialization.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">pod</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">podManager</span>.<span style="color:#a6e22e">GetPodByUID</span>(<span style="color:#a6e22e">update</span>.<span style="color:#a6e22e">PodUID</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">ok</span> {
				<span style="color:#75715e">// If the pod no longer exists, ignore the update.
</span><span style="color:#75715e"></span>				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (container unhealthy): ignore irrelevant update: %#v&#34;</span>, <span style="color:#a6e22e">update</span>)
				<span style="color:#66d9ef">break</span>
			}
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">1</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (container unhealthy): %q&#34;</span>, <span style="color:#a6e22e">format</span>.<span style="color:#a6e22e">Pod</span>(<span style="color:#a6e22e">pod</span>))
			<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodSyncs</span>([]<span style="color:#f92672">*</span><span style="color:#a6e22e">v1</span>.<span style="color:#a6e22e">Pod</span>{<span style="color:#a6e22e">pod</span>})
		}
	<span style="color:#66d9ef">case</span> <span style="color:#f92672">&lt;</span><span style="color:#f92672">-</span><span style="color:#a6e22e">housekeepingCh</span><span style="color:#f92672">:</span>
		<span style="color:#66d9ef">if</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">kl</span>.<span style="color:#a6e22e">sourcesReady</span>.<span style="color:#a6e22e">AllReady</span>() {
			<span style="color:#75715e">// If the sources aren&#39;t ready or volume manager has not yet synced the states,
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// skip housekeeping, as we may accidentally delete pods from unready sources.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (housekeeping, skipped): sources aren&#39;t ready yet.&#34;</span>)
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">V</span>(<span style="color:#ae81ff">4</span>).<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;SyncLoop (housekeeping)&#34;</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:</span><span style="color:#f92672">=</span> <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">HandlePodCleanups</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nil</span> {
				<span style="color:#a6e22e">klog</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Failed cleaning pods: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
			}
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}
</code></pre></div><p>아까 보았던 로그가 여기서 생성되는것 을 확인가능.</p>
<p>파드를 삭제해서 로그를 살펴보자
kube event watch
<img src="spider.png" alt="spider.png"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24.416476</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">kubelet</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1904</span>] <span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">SyncLoop</span> (<span style="color:#a6e22e">DELETE</span>, <span style="color:#e6db74">&#34;api&#34;</span>)<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(**5154def3-e139-48fc-a9dd-da13b691583b**)&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24.416772</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">kuberuntime_container</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">581</span>] <span style="color:#a6e22e">Killing</span> <span style="color:#a6e22e">container</span> <span style="color:#e6db74">&#34;docker://f9810afd20eb486c1b04001f2531f15ba82a7a428219fec1199733d8c2b27434&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#ae81ff">30</span> <span style="color:#a6e22e">second</span> <span style="color:#a6e22e">grace</span> <span style="color:#a6e22e">period</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24.416843</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">kuberuntime_container</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">581</span>] <span style="color:#a6e22e">Killing</span> <span style="color:#a6e22e">container</span> <span style="color:#e6db74">&#34;docker://5194b2f95969d12c65416c81fcca35dfc93332940a824dfa0862290adb2a213d&#34;</span> <span style="color:#66d9ef">with</span> <span style="color:#ae81ff">30</span> <span style="color:#a6e22e">second</span> <span style="color:#a6e22e">grace</span> <span style="color:#a6e22e">period</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24.768784</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">kubelet</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1933</span>] <span style="color:#a6e22e">SyncLoop</span> (<span style="color:#a6e22e">PLEG</span>)<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(5154def3-e139-48fc-a9dd-da13b691583b)&#34;</span>, <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">PodLifecycleEvent</span>{<span style="color:#a6e22e">ID</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>, <span style="color:#a6e22e">Type</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ContainerDied&#34;</span>, <span style="color:#a6e22e">Data</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;f9810afd20eb486c1b04001f2531f15ba82a7a428219fec1199733d8c2b27434&#34;</span>}
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">25.536213</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">prober</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">112</span>] <span style="color:#a6e22e">Readiness</span> <span style="color:#a6e22e">probe</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(5154def3-e139-48fc-a9dd-da13b691583b):istio-proxy&#34;</span> <span style="color:#a6e22e">failed</span> (<span style="color:#a6e22e">failure</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//10.233.74.93:15020/healthz/ready: dial tcp 10.233.74.93:15020: connect: connection refused
</span><span style="color:#75715e"></span><span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">27.536196</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">prober</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">112</span>] <span style="color:#a6e22e">Readiness</span> <span style="color:#a6e22e">probe</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(5154def3-e139-48fc-a9dd-da13b691583b):istio-proxy&#34;</span> <span style="color:#a6e22e">failed</span> (<span style="color:#a6e22e">failure</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//10.233.74.93:15020/healthz/ready: dial tcp 10.233.74.93:15020: connect: connection refused
</span><span style="color:#75715e"></span><span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.536089</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">prober</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">112</span>] <span style="color:#a6e22e">Readiness</span> <span style="color:#a6e22e">probe</span> <span style="color:#66d9ef">for</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(5154def3-e139-48fc-a9dd-da13b691583b):istio-proxy&#34;</span> <span style="color:#a6e22e">failed</span> (<span style="color:#a6e22e">failure</span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Get</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//10.233.74.93:15020/healthz/ready: dial tcp 10.233.74.93:15020: connect: connection refused
</span><span style="color:#75715e"></span><span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.723</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">plugin</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">442</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Extracted</span> <span style="color:#a6e22e">identifiers</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">Node</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prdcos-slave11&#34;</span> <span style="color:#a6e22e">Orchestrator</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;k8s&#34;</span> <span style="color:#a6e22e">WorkloadEndpoint</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prdcos--slave11-k8s-devops--test--server--77d445697f--d5m97-eth0&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.726</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">477</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Releasing</span> <span style="color:#a6e22e">IP</span> <span style="color:#a6e22e">address</span>(<span style="color:#a6e22e">es</span>) <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.726</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">utils</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">168</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Calico</span> <span style="color:#a6e22e">CNI</span> <span style="color:#a6e22e">releasing</span> <span style="color:#a6e22e">IP</span> <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.772</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746826</span>] <span style="color:#a6e22e">ipam_plugin</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">299</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Releasing</span> <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">handleID</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">HandleID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cni0.0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">Workload</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prdcos--slave11-k8s-devops--test--server--77d445697f--d5m97-eth0&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.772</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746826</span>] <span style="color:#a6e22e">ipam</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">1164</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Releasing</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">IPs</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">handle</span> <span style="color:#e6db74">&#39;cni0.0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#39;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.783</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746826</span>] <span style="color:#a6e22e">ipam_plugin</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">308</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Released</span> <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">handleID</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">HandleID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cni0.0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">Workload</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prdcos--slave11-k8s-devops--test--server--77d445697f--d5m97-eth0&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.784</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746826</span>] <span style="color:#a6e22e">ipam_plugin</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">317</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Releasing</span> <span style="color:#a6e22e">address</span> <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">workloadID</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">HandleID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;cni0.0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span> <span style="color:#a6e22e">Workload</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;prdcos--slave11-k8s-devops--test--server--77d445697f--d5m97-eth0&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.784</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746826</span>] <span style="color:#a6e22e">ipam</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">1164</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Releasing</span> <span style="color:#a6e22e">all</span> <span style="color:#a6e22e">IPs</span> <span style="color:#66d9ef">with</span> <span style="color:#a6e22e">handle</span> <span style="color:#e6db74">&#39;live.devops-test-server-77d445697f-d5m97&#39;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.787</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">481</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Cleaning</span> <span style="color:#a6e22e">up</span> <span style="color:#a6e22e">netns</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.788</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">network_linux</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">450</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Calico</span> <span style="color:#a6e22e">CNI</span> <span style="color:#a6e22e">deleting</span> <span style="color:#a6e22e">device</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">netns</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">proc</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1159948</span><span style="color:#f92672">/</span><span style="color:#a6e22e">ns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">net</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.825</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">network_linux</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">467</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Calico</span> <span style="color:#a6e22e">CNI</span> <span style="color:#a6e22e">deleted</span> <span style="color:#a6e22e">device</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">netns</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">proc</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1159948</span><span style="color:#f92672">/</span><span style="color:#a6e22e">ns</span><span style="color:#f92672">/</span><span style="color:#a6e22e">net</span> <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">2020</span><span style="color:#f92672">-</span><span style="color:#ae81ff">07</span><span style="color:#f92672">-</span><span style="color:#ae81ff">23</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.825</span> [<span style="color:#a6e22e">INFO</span>][<span style="color:#ae81ff">1746797</span>] <span style="color:#a6e22e">k8s</span>.<span style="color:#a6e22e">go</span> <span style="color:#ae81ff">493</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Teardown</span> <span style="color:#a6e22e">processing</span> <span style="color:#a6e22e">complete</span>. <span style="color:#a6e22e">ContainerID</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">29.868810</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">kubelet</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1933</span>] <span style="color:#a6e22e">SyncLoop</span> (<span style="color:#a6e22e">PLEG</span>)<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(5154def3-e139-48fc-a9dd-da13b691583b)&#34;</span>, <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">PodLifecycleEvent</span>{<span style="color:#a6e22e">ID</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;**5154def3-e139-48fc-a9dd-da13b691583b**&#34;</span>, <span style="color:#a6e22e">Type</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ContainerDied&#34;</span>, <span style="color:#a6e22e">Data</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;5194b2f95969d12c65416c81fcca35dfc93332940a824dfa0862290adb2a213d&#34;</span>}
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">30.894194</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">kubelet</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1933</span>] <span style="color:#a6e22e">SyncLoop</span> (<span style="color:#a6e22e">PLEG</span>)<span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;devops-test-server-77d445697f-d5m97_live(5154def3-e139-48fc-a9dd-da13b691583b)&#34;</span>, <span style="color:#a6e22e">event</span><span style="color:#f92672">:</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">pleg</span>.<span style="color:#a6e22e">PodLifecycleEvent</span>{<span style="color:#a6e22e">ID</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;5**154def3-e139-48fc-a9dd-da13b691583b**&#34;</span>, <span style="color:#a6e22e">Type</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;ContainerDied&#34;</span>, <span style="color:#a6e22e">Data</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;0d540964a67f2b6b27bfd07027395619a4d9222c89a1de627d389de1fbb50285&#34;</span>}
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.031077</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">reconciler</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">177</span>] <span style="color:#a6e22e">operationExecutor</span>.<span style="color:#a6e22e">UnmountVolume</span> <span style="color:#a6e22e">started</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;istio-envoy&#34;</span> (<span style="color:#a6e22e">UniqueName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;kubernetes.io/empty-dir/5154def3-e139-48fc-a9dd-da13b691583b-istio-envoy&#34;</span>) <span style="color:#a6e22e">pod</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span> (<span style="color:#a6e22e">UID</span><span style="color:#f92672">:</span> <span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span>)<span style="color:#f92672">*</span><span style="color:#f92672">*</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.031149</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">reconciler</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">177</span>] <span style="color:#a6e22e">operationExecutor</span>.<span style="color:#a6e22e">UnmountVolume</span> <span style="color:#a6e22e">started</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;default-token-5m57n&#34;</span> (<span style="color:#a6e22e">UniqueName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;kubernetes.io/secret/5154def3-e139-48fc-a9dd-da13b691583b-default-token-5m57n&#34;</span>) <span style="color:#a6e22e">pod</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span> <span style="color:#f92672">*</span><span style="color:#f92672">*</span>(<span style="color:#a6e22e">UID</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span>)
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.048406</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">operation_generator</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">860</span>] <span style="color:#a6e22e">UnmountVolume</span>.<span style="color:#a6e22e">TearDown</span> <span style="color:#a6e22e">succeeded</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;kubernetes.io/empty-dir/5154def3-e139-48fc-a9dd-da13b691583b-istio-envoy&#34;</span> (<span style="color:#a6e22e">OuterVolumeSpecName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;istio-envoy&#34;</span>) <span style="color:#a6e22e">pod</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span> (<span style="color:#a6e22e">UID</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span>). <span style="color:#a6e22e">InnerVolumeSpecName</span> <span style="color:#e6db74">&#34;istio-envoy&#34;</span>. <span style="color:#a6e22e">PluginName</span> <span style="color:#e6db74">&#34;kubernetes.io/empty-dir&#34;</span>, <span style="color:#a6e22e">VolumeGidValue</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.053611</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">operation_generator</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">860</span>] <span style="color:#a6e22e">UnmountVolume</span>.<span style="color:#a6e22e">TearDown</span> <span style="color:#a6e22e">succeeded</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;kubernetes.io/secret/5154def3-e139-48fc-a9dd-da13b691583b-default-token-5m57n&#34;</span> (<span style="color:#a6e22e">OuterVolumeSpecName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;default-token-5m57n&#34;</span>) <span style="color:#a6e22e">pod</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span> (<span style="color:#a6e22e">UID</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span>). <span style="color:#a6e22e">InnerVolumeSpecName</span> <span style="color:#e6db74">&#34;default-token-5m57n&#34;</span>. <span style="color:#a6e22e">PluginName</span> <span style="color:#e6db74">&#34;kubernetes.io/secret&#34;</span>, <span style="color:#a6e22e">VolumeGidValue</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.053704</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">operation_generator</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">860</span>] <span style="color:#a6e22e">UnmountVolume</span>.<span style="color:#a6e22e">TearDown</span> <span style="color:#a6e22e">succeeded</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;kubernetes.io/secret/5154def3-e139-48fc-a9dd-da13b691583b-istio-certs&#34;</span> (<span style="color:#a6e22e">OuterVolumeSpecName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;istio-certs&#34;</span>) <span style="color:#a6e22e">pod</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span> (<span style="color:#a6e22e">UID</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;5154def3-e139-48fc-a9dd-da13b691583b&#34;</span>). <span style="color:#a6e22e">InnerVolumeSpecName</span> <span style="color:#e6db74">&#34;istio-certs&#34;</span>. <span style="color:#a6e22e">PluginName</span> <span style="color:#e6db74">&#34;kubernetes.io/secret&#34;</span>, <span style="color:#a6e22e">VolumeGidValue</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.131597</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">reconciler</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">297</span>] <span style="color:#a6e22e">Volume</span> <span style="color:#a6e22e">detached</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;default-token-5m57n&#34;</span> (<span style="color:#a6e22e">UniqueName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;kubernetes.io/secret/5154def3-e139-48fc-a9dd-da13b691583b-default-token-5m57n&#34;</span>) <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">node</span> <span style="color:#e6db74">&#34;prdcos-slave11&#34;</span> <span style="color:#a6e22e">DevicePath</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.131619</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">reconciler</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">297</span>] <span style="color:#a6e22e">Volume</span> <span style="color:#a6e22e">detached</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;istio-certs&#34;</span> (<span style="color:#a6e22e">UniqueName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;kubernetes.io/secret/5154def3-e139-48fc-a9dd-da13b691583b-istio-certs&#34;</span>) <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">node</span> <span style="color:#e6db74">&#34;prdcos-slave11&#34;</span> <span style="color:#a6e22e">DevicePath</span> <span style="color:#e6db74">&#34;&#34;</span>
<span style="color:#a6e22e">kubelet</span>[<span style="color:#ae81ff">3866895</span>]<span style="color:#f92672">:</span> <span style="color:#a6e22e">I0723</span> <span style="color:#ae81ff">01</span><span style="color:#f92672">:</span><span style="color:#ae81ff">14</span><span style="color:#f92672">:</span><span style="color:#ae81ff">31.131628</span> <span style="color:#ae81ff">3866895</span> <span style="color:#a6e22e">reconciler</span>.<span style="color:#a6e22e">go</span><span style="color:#f92672">:</span><span style="color:#ae81ff">297</span>] <span style="color:#a6e22e">Volume</span> <span style="color:#a6e22e">detached</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">volume</span> <span style="color:#e6db74">&#34;istio-envoy&#34;</span> (<span style="color:#a6e22e">UniqueName</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;kubernetes.io/empty-dir/5154def3-e139-48fc-a9dd-da13b691583b-istio-envoy&#34;</span>) <span style="color:#a6e22e">on</span> <span style="color:#a6e22e">node</span> <span style="color:#e6db74">&#34;prdcos-slave11&#34;</span> <span style="color:#a6e22e">DevicePath</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>
</code></pre></div><p>syncLoop에서 delete api요청을 받았음을 로그로 적시해두고 pleg와 관련한 이벤트id를 함께 주었다. (configCh을 통해 이벤트를 전달받음)</p>
<p>pod lifecycle event id  grep 으로 일련의 이벤트에 따른 플로우를 추적가능하다.</p>
<p>내가 서비스하는 환경에서는 Calico CNI 함께 사용하기 때문에 관련된 ip 릴리즈 과정까지 함께 확인할 수 있었다.</p>
<p>여담으로 handler.HandlePodUpdates(u.Pods) 함수를 실행하게되면 kubelet의 dispatchWorker 함수를 통해 파드업데이트에 대한 이벤트를 전파한다. 이벤트를 전달받은 podWorker, podManager등 각각의 컴포넌트들이 해당 파드에 대한 상태를 확인하며 update작업을 이행한다(configMap unregister, secret unmount etc) 동시성 이슈가 있는작업이다보니 mutex함수들이 컴포넌트들에 많이 보이게된다. 로그 수준을 v4 로 수준으로 낮추면 해당 각 컴포넌트들의 작업로그를 다확인할 수 있다.</p>
<p>맨앞으로 돌아가서 pleg relist period 가 1초였던것을 기억하는가</p>
<p>1초는 디폴트 루프 타임인데&hellip; 컨테이너상태를 최신화 relist 하는데 동기적으로 작동하는 루프타임이기에 다음 루프는 컨테이너 상태 최신화가 느려질수록 더 느려지게된다.
relist
그러므로 컨테이너간의 cni이슈나 머신에 컨테이너가 너무많이 떠서 이슈가 생기거나. 코어가 부족해서 머신이 힘들어하거나 등등 기타 이슈들을 이 relist latency 메트릭으로 미리 감지할수있다.</p>
<p>Even though relist is set as calling every 1s, it can take more than 1s to finish**. If the container runtime responds slowly and/or when there are many container changes in one cycl**e. So, the next relist will call after the previous one is complete. For example, if relist takes 5s to complete, then next relist time is 6s (1s + 5s).</p>
<p>근데 이것이 심해져서 3분이 넘어가면 pleg is no healthy 라는 에러를 큐블렛이 자체적으로 뿜는다.</p>
<p>코어 8개짜리 머신에서 리소스가 현저히 부족한 곳에 부하테스트를 쭈욱 돌렸더니 실제 발생했던 에러 로그</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#a6e22e">PLEG</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">not</span> <span style="color:#a6e22e">healthy</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">pleg</span> <span style="color:#a6e22e">was</span> <span style="color:#a6e22e">last</span> <span style="color:#a6e22e">seen</span> <span style="color:#a6e22e">active</span> <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m29</span><span style="color:#ae81ff">.89897787</span><span style="color:#a6e22e">s</span> <span style="color:#a6e22e">ago</span>; <span style="color:#a6e22e">threshold</span> <span style="color:#a6e22e">is</span> <span style="color:#ae81ff">3</span><span style="color:#a6e22e">m0s</span>
</code></pre></div><p>PLEG is not healthy는
다양한 원인으로 인해 발생할 수 있다.</p>
<ul>
<li>컨테이너 런타임 레이턴시 또는 타임아웃 (성능, 교착상태, 버그 등)</li>
<li>너무 많은 파드가 호스트에 떠있고 리소스가 부족해 relist 를 3분이내에 못한케이스</li>
<li>CNI 버그로 파드 네트워크 상태를 못가져오는경우 등등</li>
</ul>
<p>위에서 언급한대로 relist latency 메트릭이 제공되고 있으니 해당 레이턴시에 대한 어럴트를 적정수준으로 설정해두면 머신에 있는 이슈를 미리 감지할 수 있고 더나아가 노드 증설 및 서비스 리밸런싱을 고려해볼 수 있다.
<img src="relist.png" alt="relist.png"></p>
<p>누군가에게 막막한 쿠버네티스 운영에 조금이나마 도움이 되었으면한다ㅎㅎ</p>
<p>다음 시간에는 kubelet 이야기 2편로 kubeDeps.Recorder에 대해서 이야기해보겠다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-jsx" data-lang="jsx"><span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">probeManager</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">prober</span>.<span style="color:#a6e22e">NewManager</span>(
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">statusManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">livenessManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">startupManager</span>,
		<span style="color:#a6e22e">klet</span>.<span style="color:#a6e22e">runner</span>,
		<span style="color:#f92672">*</span><span style="color:#f92672">*</span><span style="color:#a6e22e">kubeDeps</span>.<span style="color:#a6e22e">Recorder</span><span style="color:#f92672">*</span><span style="color:#f92672">*</span>)
</code></pre></div><p>참고
<a href="https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes/"><a href="https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes/">https://developers.redhat.com/blog/2019/11/13/pod-lifecycle-event-generator-understanding-the-pleg-is-not-healthy-issue-in-kubernetes/</a></a></p>
<p><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/pod-lifecycle-event-generator.md"><a href="https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/pod-lifecycle-event-generator.md">https://github.com/kubernetes/community/blob/master/contributors/design-proposals/node/pod-lifecycle-event-generator.md</a></a></p>

    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/k8s">k8s</a>
                
                    <a href="https://aidanbae.github.io/tags/debug">debug</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    
        <div class="article-wrapper u-cf">
            
                <a class="bubble" href="https://aidanbae.github.io/code/devops/k8s/header/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://aidanbae.github.io/code/devops/k8s/header/">envoy와 x-forwarded-proto 헤더 이슈</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-12-05</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
                    <a href="https://aidanbae.github.io/categories/devops">DevOps</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        게임서버를 할땐 x-forwarded 헤더에 대해 깊게 다룰일이 없었는데 프론트단부터 거치는 프록시 서버들이 많은 시스템을 운영하다보니 접속 클라이언트의 정보가 담긴 x-forwarded 헤더를 공부할 기회가 생겼다.
x-로 시작하는 헤더는 사용자가 임의로 정의한 헤더를 나타냅니다. 근데 nginx등 오픈소스들이 워낙 많이 쓰이다보니 사실상 표준이 된 케이스가 x-forwarded-* 시리즈임.
x-forwarded-for, x-forwarded-proto, x-forwarded-host 위 삼총사는 de-facto standard 헤더로 사실상 표준이 되어버린 헤더임. 이 삼총사는 한세트 묶음으로 보통 전달되며 클라우드 업계에서도 표준으로 자리잡고있음. https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Forwarded
예를들면 아래처럼 사용될 수 있습니다.

        
            <a href="https://aidanbae.github.io/code/devops/k8s/header/" class="more">Continue reading</a>
        
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/istio">istio</a>
                
                    <a href="https://aidanbae.github.io/tags/x-forwarded">x-forwarded</a>
                
                    <a href="https://aidanbae.github.io/tags/header">header</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    
        <div class="article-wrapper u-cf">
            
                <a class="bubble" href="https://aidanbae.github.io/code/devops/k8s/istio-mixer-debug/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://aidanbae.github.io/code/devops/k8s/istio-mixer-debug/">istio debug를 위한 controlZ 활용</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-11-30</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
                    <a href="https://aidanbae.github.io/categories/devops">DevOps</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        istio의 mixer는 서비스에 대한 원격 분석등의 수집을 도와주는 유연한 모델이다. 서비스 옆에 붙어 있는 istio-proxy들의 수집되는 정보들을 mixer를 통해 파이프라이닝 할 수 있다.
그림처럼 adapter api를 사용하기 때문에 다양한 어댑터를 사용해 확장성과 유연성을 다 갖춘 모델이다.
istio 믹서에 문제가 생긴다면 서비스에 대한 수집 정보들에 영향이 생길 수 있다. 그러므로 특정 서비스에 라우팅이 안되고 모니터링상 이슈가 없었다면 로그나 수집 데이터를 생성, 운반하는 믹서에 이슈가 있는지 확인해보아야한다.
istio는 쿠버네티스 대시보드처럼 손쉽게 istio의 현재 상태와 스코프 기능을 제공하는 controlZ라는 서비스를 제공하고있다.

        
            <a href="https://aidanbae.github.io/code/devops/k8s/istio-mixer-debug/" class="more">Continue reading</a>
        
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/istio">istio</a>
                
                    <a href="https://aidanbae.github.io/tags/mixer">mixer</a>
                
                    <a href="https://aidanbae.github.io/tags/debug">debug</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    
        <div class="article-wrapper u-cf">
            
                
<a class="bubble" href="https://aidanbae.github.io/video/study/msa/">
    <i class="fa fa-fw fa-video-camera"></i>
</a>

<article class="video">
    


    
        <div class="responsive-video youtube">
            <iframe src="https://www.youtube-nocookie.com/embed/xdqOxF2JqwU?rel=0" frameborder="0" allowfullscreen></iframe>
        </div>
    
    

    <div class="content">
    <h3><a href="https://aidanbae.github.io/video/study/msa/">MSA &amp; kubernetes</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-05-19</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/devops">DevOps</a>
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        2016년 12월 발표자료이긴한데
MSA에 대한 이해가 한번에 되는 발표영상이다.
요즘 MSA에 대해 물어보는 동생들이 있어서 바로 추천해주는 영상!
인상적이었던 부분 인상적이었던 부분은 MSA와 팀모델에 대해 설명하는 부분이다.
 컨웨이의 법칙
“소프트웨어의 구조는 그 소프트웨어를 만드는 팀의 구조와 일치한다.”
 &lsquo;팀의 구조??&rsquo; 조대협님 왈: 개발 설계 백날 잘해봐야 소용없음 제대로된 팀 구조를 만드는 것이 설계 그다음은 알아서 됨
정말 크게 와닿는다. 게임즈에서는 서버팀이 혼자였기때문에 설계를 모노리틱하게 설계한 것도 있음.
하지만 서버팀이 인원이 늘었을 때도 모노리틱한 구조로 1인1프로젝트가 굉장히 불편했던 것은 맞다.

        
            <a href="https://aidanbae.github.io/video/study/msa/" class="more">Continue reading</a>
        
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/kubernetes">Kubernetes</a>
                
                    <a href="https://aidanbae.github.io/tags/docker">docker</a>
                
                    <a href="https://aidanbae.github.io/tags/msa">MSA</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    
        <div class="article-wrapper u-cf">
            
                <a class="bubble" href="https://aidanbae.github.io/code/docker/docker-netstat/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    
    <div class="featured-image">
        <a href="https://aidanbae.github.io/code/docker/docker-netstat/">
            
                <img src="https://aidanbae.github.io/code/docker/docker-netstat/featuredImage_hu8fbdd1b26661cf794b0f17932fa1ae38_170191_700x350_fill_q95_box_smart1_2.png" alt="">
            
        </a>
    </div>


    <div class="content">
    <h3><a href="https://aidanbae.github.io/code/docker/docker-netstat/">Docker Container 내부 소켓 상태 확인 - nsenter와 netstat</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-04-30</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
                    <a href="https://aidanbae.github.io/categories/docker">Docker</a>
                
                    <a href="https://aidanbae.github.io/categories/devops">DevOps</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        도커로 서비스 개발을 하다보면 상태 확인을 위해 호스트 머신이 아닌 컨테이너에 접근해야하는 경우가 생긴다. 호스트 머신 한 대에 여러 docker 서비스가 떠있을 수 있기 때문이다. (내가 이용 중인 AWS(ECS)도 내가 띄운 서비스 이외에 로그수집기, executor등의 또다른 docker 컨테이너가 떠있다.) 그러므로 호스트 머신에서 netstat 명령어는 모든 도커 서비스의 소켓정보들을 보여주기때문에 특정 서비스에 대한 스코프기능이 지원되지 않는다.
도커를 조금 이용해본 개발자라면 쉽게 docker exec 명령어로 해당 컨테이너에 접근해 내부에서 소켓상태를 살펴보려할 것이다.

        
            <a href="https://aidanbae.github.io/code/docker/docker-netstat/" class="more">Continue reading</a>
        
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/docker">docker</a>
                
                    <a href="https://aidanbae.github.io/tags/netstat">netstat</a>
                
                    <a href="https://aidanbae.github.io/tags/docker-container">docker container</a>
                
                    <a href="https://aidanbae.github.io/tags/nsenter">nsenter</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    
        <div class="article-wrapper u-cf">
            
                <a class="bubble" href="https://aidanbae.github.io/code/devops/computer/cpucache/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    
    <div class="featured-image">
        <a href="https://aidanbae.github.io/code/devops/computer/cpucache/">
            
                <img src="https://aidanbae.github.io/code/devops/computer/cpucache/featuredImage_hu040e699061db3073052773bfe1b14c9d_33766_700x350_fill_q95_box_smart1.jpg" alt="">
            
        </a>
    </div>


    <div class="content">
    <h3><a href="https://aidanbae.github.io/code/devops/computer/cpucache/">CPU 캐시 이해하기</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-04-22</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
                    <a href="https://aidanbae.github.io/categories/devops">DevOps</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        CPU 캐시란? 컴퓨터 시스템의 성능을 향상 시키기 위해 주로 CPU칩 안에 포함되는 빠르고 작은 매우 비싼 메모리입니다. 프로그램에서 직접적으로 읽거나 쓸 수 없고 하드웨어의 메모리 관리 시스템이 내부적으로 제어합니다. 대부분의 프로그램은 한번 사용할 데이터를 다시 사용할 가능성이 높고, 그 주변의 데이터도 곧 사용할 가능성이 높은 데이터 지역성을 가지고 있다. 데이터 지역성을 활용하여 메인 메모리에 있는 데이터를 캐시 메모리에 불러와 두고, cpu가 필요한 데이터를 캐시에서 먼저 찾도록 하면 향상시킬수 있다.
여기서 포인트는 데이터의 지역성을 활용한다!

        
            <a href="https://aidanbae.github.io/code/devops/computer/cpucache/" class="more">Continue reading</a>
        
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/cpu-cache">cpu cache</a>
                
                    <a href="https://aidanbae.github.io/tags/cpu-%EC%BA%90%EC%8B%9C">cpu 캐시</a>
                
                    <a href="https://aidanbae.github.io/tags/%EC%BA%90%EC%8B%9C%EB%9D%BC%EC%9D%B8">캐시라인</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    
        <div class="article-wrapper u-cf">
            
                <a class="bubble" href="https://aidanbae.github.io/code/devops/computer/tcmalloc/">
    <i class="fa fa-fw fa-code"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h3><a href="https://aidanbae.github.io/code/devops/computer/tcmalloc/">tcmalloc</a></h3>
    <div class="meta">
        
            
                <span class="date moment">2019-04-16</span>
            
        

        

        
            <span class="categories">
                
                    <a href="https://aidanbae.github.io/categories/server">Server</a>
                
            </span>
        

        
            <span class="author"><a href="https://aidanbae.github.io/author/aidan.bae">Aidan.bae</a></span>
        
    </div>

    
        go tune memory 발표자료를 보면서 구경한 파생 지식 tcmalloc
구글 공식 문서 http://goog-perftools.sourceforge.net/doc/tcmalloc.html
구글에서 만든 TCMalloc
보통 멀티 스레드 환경의 서버를 만들다보면 메모리 풀을 사용하게 된다.
메모리 풀의 이점:
 빠른메모리할당 메모리 단편화 감소  하나의 거대한 메모리 풀을 사용하면 단순하게 malloc을 호출해서 메모리를 할당하는 것 보다 속도가 빠르다. 메모리 풀에 따라 다르겠지만 일반적으로 볼ㄸ ㅐ 처음 프로그래밍이 실행될 때 필요한 메모리를 통째로 잡아놓고 메모리가 필요한 경우에는 잡아놓은메모리 안에서 잘라서 주기 때문입니다.

        
            <a href="https://aidanbae.github.io/code/devops/computer/tcmalloc/" class="more">Continue reading</a>
        
    
</div>

    
<div class="footer">


    
        <div class="tags">
            <i class="fa fa-tags"></i>
            <div class="links">
                
                    <a href="https://aidanbae.github.io/tags/tcmalloc">tcmalloc</a>
                
                    <a href="https://aidanbae.github.io/tags/malloc">malloc</a>
                
                    <a href="https://aidanbae.github.io/tags/computer-science">computer science</a>
                
            </div>
        </div>
    

    
</div>

</article>

            
        </div>
    

    
    <div class="paginator">
        
            <a href="https://aidanbae.github.io/categories/server/page/2/" class="older"><i class="fa fa-angle-double-left"></i> Older posts</a>
        

        
    </div>



        </div>

        
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
                <ul>
                
                    <li>
                        <a href="https://aidanbae.github.io/audio/chaos/">너의 혼돈을 사랑하라</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/code/devops/k8s/pleg/">PLEG(Pod LifeCycle Event Generator)와 kubelet</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/code/devops/bazel/">bazel 빌드</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/video/toss/">위대한 성취는 위대한 목표로부터</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/article/book/niche/">니체의말</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/code/golang/tcp-server/">TCP 서버 구현과 패킷분석</a>
                    </li>
                
                </ul>
        </div>
        

        
        <div class="categories">
            <a href="https://aidanbae.github.io/categories/"><strong>Categories</strong></a>
                <ul>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/code">Code (20)</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/golang">Golang (17)</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/wisdom">Wisdom (15)</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/book">Book (14)</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/devops">Devops (13)</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/server">Server (13)</a>
                    </li>
                
                    <li>
                        <a href="https://aidanbae.github.io/categories/smalltalk">Smalltalk (13)</a>
                    </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>

                
                
                
                
                
                
                
                
                
                
                    <a href="https://github.com/aidanbae" target="_blank"><i class="fa fa-github"></i></a>
                
                
            </div>
            

            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/Lednerb" target="_blank">
                &copy;
                
                    2017
                
                by Lednerb
            </a>
	    -
		<a href="https://aidanbae.github.io/categories/server/index.xml">RSS</a>
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme" target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


        

        

        
        
        <script type="text/javascript" src="https://aidanbae.github.io/js/externalDependencies.39c47e10e241eae2947b3fe21809c572.js" integrity="md5-OcR&#43;EOJB6uKUez/iGAnFcg=="></script>

        
        
        <script type="text/javascript" src="https://aidanbae.github.io/js/theme.ff50ae6dc1bfc220b23bf69dbb41b54e.js" integrity="md5-/1CubcG/wiCyO/adu0G1Tg=="></script>

        <script>
            $(".moment").each(function() {
                $(this).text(
                    moment( $(this).text() )
                        .locale( "en" )
                        .format('LL')
                );
            });

            $(".footnote-return sup").html("");
        </script>

        
            
        

        


    </body>
</html>
